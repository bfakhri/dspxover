#include "filter.h"

#define PI 3.14159265
#define TAPS_LP 400
#define TAPS_HP 600 

// Filter taps generated here: http://www.arc.id.au/FilterDesign.html
// They are low precision and should be changed to high precision taps
// The filter assumes a 96kHz sample rate!!!!!!

static double FIR_LP[TAPS_LP] = {
-0.000003554709688,0.000002913507467,0.000003335956088,0.000004405145368,0.000005968068664,0.000007958302568,0.000010346266451,0.000013114227795,0.000016243350455,0.000019706680548,0.00002346515724,0.000027465279623,0.000031637805984,0.000035897218771,0.000040141856409,0.000044254687803,0.00004810473357,0.000051549142356,0.000054435922195,0.000056607311357,0.000057903753478,0.000058168419853,0.000057252198692,0.000055019048052,0.000051351586872,0.000046156777927,0.000039371538575,0.000030968100503,0.000020958929326,0.000009401009318,-0.000003600701396,-0.00001789083387,-0.000033262365901,-0.000049456731518,-0.000066165414366,-0.000083033125207,-0.000099662626145,-0.000115621221333,-0.000130448886672,-0.000143667960477,-0.000154794264441,-0.000163349470968,-0.000168874480491,-0.000170943522496,-0.000169178648232,-0.000163264243232,-0.000152961155397,-0.000138120011121,-0.000118693279047,-0.000094745639838,-0.000066462231635,-0.000034154365398,0.0000017376577,0.000040644943274,0.000081873867297,0.000124613582058,0.000167947253269,0.000210867020973,0.000252292573809,0.000291093118539,0.000326112417277,0.00035619645646,0.000380223207466,0.000397133842045,0.0004059646797,0.000405879071835,0.000396198371934,0.000376431104863,0.000346299433908,0.000305762033194,0.000255032507038,0.000194592557207,0.000125199184045,0.00004788531734,-0.000036046593801,-0.000125038348025,-0.000217297258407,-0.000310824873073,-0.000403452905003,-0.000492885920917,-0.000576750132875,-0.000652647434379,-0.000718213631069,-0.000771179640289,-0.000809434279477,-0.000831087135906,-0.000834529914701,-0.000818494602724,-0.00078210676646,-0.000724932325344,-0.000647016209742,-0.00054891142597,-0.000431697208689,-0.000296985142277,-0.000146912374443,0.000015878676697,0.000188274411735,0.000366737891119,0.00054737003285,0.000725983410635,0.000898187535275,0.001059484149717,0.001205370734093,0.001331450110816,0.001433543770516,0.001507806316279,0.001550838254104,0.001559794248889,0.001532483923431,0.001467462307121,0.001364107144207,0.001222680449591,0.001044371952314,0.000831322390508,0.000586625011867,0.000314304084148,0.000019269722401,-0.000292751116508,-0.000615307047446,-0.000941337062716,-0.001263306119121,-0.001573359311785,-0.001863491882171,-0.002125731790468,-0.002352331120478,-0.002535962191927,-0.002669913943466,-0.002748283930471,-0.002766161164502,-0.002719795013005,-0.002606745483372,-0.002426010436956,-0.002178125615631,-0.001865233812457,-0.001491120072974,-0.0010612104654,-0.000582532695052,-0.000063637646365,0.000485518201277,0.001053728638491,0.001628730110294,0.002197427946936,0.002746152882243,0.003260943461904,0.003727849174167,0.004133248454347,0.004464175141267,0.004708646515364,0.004855985739126,0.004897131362709,0.004824926559563,0.004634380923859,0.004322897994964,0.00389046217176,0.003339779335125,0.002676366300282,0.001908585158298,0.001047619620592,0.000107391631535,-0.000895582260998,-0.001942394014256,-0.003012004621522,-0.004081558721535,-0.005126748691812,-0.00612222244509,-0.00704202805447,-0.007860087358236,-0.008550689863962,-0.009088997605135,-0.009451551120418,-0.009616766440565,-0.009565412891303,-0.009281061658347,-0.008750495414427,-0.007964069874383,-0.006916018914841,-0.005604695856778,-0.004032744645189,-0.002207195948434,-0.000139484615619,0.002154613554853,0.00465512619973,0.007338108774643,0.010175946164593,0.013137727163412,0.016189685947023,0.01929570324888,0.022417858661898,0.025517024368071,0.028553489660524,0.031487604894412,0.03428043300034,0.036894396429321,0.039293907379101,0.041445969380244,0.043320738793383,0.044892035477993,0.046137792824293,0.047040438474758,0.047587198377232,0.047770318280737,0.047587198377232,0.047040438474758,0.046137792824293,0.044892035477993,0.043320738793383,0.041445969380244,0.039293907379101,0.036894396429321,0.03428043300034,0.031487604894412,0.028553489660524,0.025517024368071,0.022417858661898,0.01929570324888,0.016189685947023,0.013137727163412,0.010175946164593,0.007338108774643,0.00465512619973,0.002154613554853,-0.000139484615619,-0.002207195948434,-0.004032744645189,-0.005604695856778,-0.006916018914841,-0.007964069874383,-0.008750495414427,-0.009281061658347,-0.009565412891303,-0.009616766440565,-0.009451551120418,-0.009088997605135,-0.008550689863962,-0.007860087358236,-0.00704202805447,-0.00612222244509,-0.005126748691812,-0.004081558721535,-0.003012004621522,-0.001942394014256,-0.000895582260998,0.000107391631535,0.001047619620592,0.001908585158298,0.002676366300282,0.003339779335125,0.00389046217176,0.004322897994964,0.004634380923859,0.004824926559563,0.004897131362709,0.004855985739126,0.004708646515364,0.004464175141267,0.004133248454347,0.003727849174167,0.003260943461904,0.002746152882243,0.002197427946936,0.001628730110294,0.001053728638491,0.000485518201277,-0.000063637646365,-0.000582532695052,-0.0010612104654,-0.001491120072974,-0.001865233812457,-0.002178125615631,-0.002426010436956,-0.002606745483372,-0.002719795013005,-0.002766161164502,-0.002748283930471,-0.002669913943466,-0.002535962191927,-0.002352331120478,-0.002125731790468,-0.001863491882171,-0.001573359311785,-0.001263306119121,-0.000941337062716,-0.000615307047446,-0.000292751116508,0.000019269722401,0.000314304084148,0.000586625011867,0.000831322390508,0.001044371952314,0.001222680449591,0.001364107144207,0.001467462307121,0.001532483923431,0.001559794248889,0.001550838254104,0.001507806316279,0.001433543770516,0.001331450110816,0.001205370734093,0.001059484149717,0.000898187535275,0.000725983410635,0.00054737003285,0.000366737891119,0.000188274411735,0.000015878676697,-0.000146912374443,-0.000296985142277,-0.000431697208689,-0.00054891142597,-0.000647016209742,-0.000724932325344,-0.00078210676646,-0.000818494602724,-0.000834529914701,-0.000831087135906,-0.000809434279477,-0.000771179640289,-0.000718213631069,-0.000652647434379,-0.000576750132875,-0.000492885920917,-0.000403452905003,-0.000310824873073,-0.000217297258407,-0.000125038348025,-0.000036046593801,0.00004788531734,0.000125199184045,0.000194592557207,0.000255032507038,0.000305762033194,0.000346299433908,0.000376431104863,0.000396198371934,0.000405879071835,0.0004059646797,0.000397133842045,0.000380223207466,0.00035619645646,0.000326112417277,0.000291093118539,0.000252292573809,0.000210867020973,0.000167947253269,0.000124613582058,0.000081873867297,0.000040644943274,0.0000017376577,-0.000034154365398,-0.000066462231635,-0.000094745639838,-0.000118693279047,-0.000138120011121,-0.000152961155397,-0.000163264243232,-0.000169178648232,-0.000170943522496,-0.000168874480491,-0.000163349470968,-0.000154794264441,-0.000143667960477,-0.000130448886672,-0.000115621221333,-0.000099662626145,-0.000083033125207,-0.000066165414366,-0.000049456731518,-0.000033262365901,-0.00001789083387,-0.000003600701396,0.000009401009318,0.000020958929326,0.000030968100503,0.000039371538575,0.000046156777927,0.000051351586872,0.000055019048052,0.000057252198692,0.000058168419853,0.000057903753478,0.000056607311357,0.000054435922195,0.000051549142356,0.00004810473357,0.000044254687803,0.000040141856409,0.000035897218771,0.000031637805984,0.000027465279623,0.00002346515724,0.000019706680548,0.000016243350455,0.000013114227795,0.000010346266451,0.000007958302568,0.000005968068664,0.000004405145368,0.000003335956088,0.000002913507467,-0.000003554709688};



static double FIR_HP[TAPS_HP] = {-0.00000637524475755047,-0.00000308119204939162,-0.00000377506230188068,-0.00000453134103870168,-0.00000534397442183073,-0.00000620484044729922,-0.00000710366970929241,-0.00000802800230811973,-0.00000896318594807151,-0.00000989241929479006,-0.0000107968436559298,-0.0000116556854204182,-0.0000124464514674725,-0.000013145178644377,-0.000013726737038234,-0.0000141651858865594,-0.0000144341799410243,-0.0000145074229321298,-0.0000143591634872533,-0.0000139647275313015,-0.0000133010801612658,-0.0000123474088493083,-0.0000110857187222037,-0.00000950142971784119,-0.00000758396449957796,-0.00000532731542799326,-0.00000273057827904459,0.000000201559838643236,0.00000345839111595156,0.00000702282877715988,0.0000108711321657484,0.0000149727267584178,0.0000192901298433828,0.0000237789914287717,0.0000283882585667057,0.0000330604696224231,0.0000377321831421186,0.0000423345438783766,0.0000467939862492503,0.0000510330730647211,0.0000549714647899915,0.0000585270119571132,0.0000616169606475209,0.0000641592582682906,0.0000660739442081081,0.0000672846074199914,0.0000677198905913184,0.0000673150183943195,0.0000660133253803229,0.000063767757493213,0.0000605423199038037,0.0000563134430434693,0.0000510712382766032,0.0000448206147419259,0.0000375822294275305,0.0000293932436494599,0.000020307860694949,0.000010397621551462,-0.000000248561695288832,-0.00001152465202471,-0.0000233080267694722,-0.0000354603194814351,-0.0000478285693020206,-0.000060246677911258,-0.0000725371689682364,-0.0000845132396140161,-0.0000959810881062454,-0.000106742496141414,-0.000116597638926578,-0.000125348090743526,-0.000132799988647913,-0.000138767312211351,-0.000143075232907377,-0.000145563482985853,-0.000146089690549095,-0.000144532625133374,-0.000140795296486086,-0.000134807848476977,-0.000126530190259043,-0.000115954307930142,-0.000103106202088968,-0.0000880473998242731,-0.0000708759938427668,-0.0000517271665913043,-0.0000307731633448303,-0.00000822268524369438,0.000015680318885963,0.0000406584745065491,0.0000664034204855043,0.0000925788589573283,0.0001188241994075,0.000144758770094567,0.000169986559493412,0.00019410144010156,0.000216692816877441,0.000237351632950182,0.000255676656235312,0.000271280962382867,0.000283798522247939,0.00029289079596778,0.000298253230910239,0.000299621557357018,0.000296777773927709,0.000289555714532199,0.000277846090140758,0.000261600901934386,0.00024083712746996,0.000215639588363363,0.000186162916628984,0.000152632547154524,0.000115344675744861,0.0000746651356170396,0.000031027160019411,-0.0000150719853953071,-0.0000630754998979815,-0.000112372656518887,-0.000162305486069016,-0.000212176481681707,-0.000261257250935561,-0.000308798024707428,-0.000354037914652738,-0.000396215794920885,-0.000434581668682989,-0.000468408366567089,-0.000497003412438509,-0.000519720882389273,-0.000535973075544534,-0.000545241810565124,-0.000547089159698465,-0.000541167433046304,-0.000527228229476696,-0.000505130377368111,-0.000474846598147686,-0.000436468738340103,-0.000390211431494342,-0.000336414069773947,-0.000275540985999832,-0.000208179770298563,-0.000135037670959719,-0.0000569360563282056,0.0000251970568035976,0.000110336373173289,0.000197370521992854,0.000285114997024577,0.000372326707823786,0.000457719986833897,0.000539983868930691,0.000617800433663844,0.000689863976304976,0.000754900752334185,0.000811689021606857,0.00085907910353593,0.000896013143553478,0.000921544284188286,0.000934854931567335,0.000935273810213072,0.000922291505798319,0.000895574207098815,0.00085497537474223,0.000800545085411949,0.00073253682576693,0.000651411540254871,0.000557838770921926,0.000452694764881248,0.000337057465852717,0.000212198349619502,0.0000795711088007795,-0.000059202760601327,-0.000202351370516586,-0.000347972701557222,-0.000494057517277434,-0.000638514689806091,-0.000779198650535429,-0.000913938638121845,-0.00104056937809392,-0.00115696279454587,-0.00126106032536242,-0.00135090538875969,-0.00142467553116284,-0.00148071377502632,-0.00151755868051019,-0.00153397263724029,-0.00152896791188667,-0.00150182999408168,-0.00145213780724673,-0.00137978038207763,-0.00128496962851463,-0.00116824888664946,-0.00103049698774361,-0.000872927612794052,-0.000697083797228425,-0.000504827495597012,-0.000298324188725302,-0.0000800225867963989,0.000147370445711614,0.000380919544415395,0.000617494807638463,0.000853809725526682,0.00108646266607783,0.0013119814444287,0.00152687044251632,0.00172765969283364,0.00191095529337147,0.00207349048183871,0.00221217666665937,0.00232415369072974,0.00240683859204616,0.0024579721235205,0.00247566230288982,0.00245842428276349,0.00240521586055087,0.00231546798813999,0.0021891096914678,0.00202658687009381,0.00182887451597576,0.00159748196811403,0.00133445090471228,0.00104234586599819,0.000724237197745367,0.000383676406620381,0.0000246640224404445,-0.000348389832106583,-0.000730711858188885,-0.00111721857376409,-0.00150257537119792,-0.00188126103110563,-0.00224763699279651,-0.0025960205977233,-0.00292076144686691,-0.00321631994725671,-0.00347734706796875,-0.00369876428295795,-0.00387584264782596,-0.00400427994080287,-0.00408027479535711,-0.00410059676329298,-0.00406265127310421,-0.00396453848868868,-0.0038051051280543,-0.00358398836992421,-0.00330165105754718,-0.00295940750271046,-0.0025594392979313,-0.0021048006598868,-0.00159941295099129,-0.00104804815716286,-0.000456301236625852,0.000169448604637587,0.000822087512244983,0.00149382711580243,0.00217627471089687,0.0028605128691012,0.00353718772161089,0.00419660503655721,0.0048288330934597,0.00542381125237269,0.00597146302161105,0.00646181234793383,0.0068851017879842,0.00723191117070981,0.00749327532830533,0.00766079945859612,0.00772677068516773,0.00768426440315268,0.00752724403838587,0.00725065290537006,0.00685049692464134,0.00632391705195106,0.00566925037921095,0.00488607898919126,0.00397526578112388,0.00293897663106015,0.00178068840731456,0.000505182525694962,-0.000881476100543156,-0.00237197468709211,-0.00395780257685509,-0.00562931523069587,-0.00737581165928944,-0.00918562457778983,-0.0110462224054127,-0.0129443220817755,-0.0148660115329335,-0.0167968804943409,-0.018722158287149,-0.0206268570498301,-0.022495918850388,-0.0243143650464799,-0.0260674462224488,-0.0277407910141745,-0.0293205521351027,-0.0307935479398931,-0.0321473979056357,-0.0333706504740579,-0.0344529017808662,-0.0353849038993546,-0.0361586613434645,-0.0367675147091615,-0.0372062104806452,-0.0374709561877488,0.962440539729143,-0.0374709561877488,-0.0372062104806452,-0.0367675147091615,-0.0361586613434645,-0.0353849038993546,-0.0344529017808662,-0.0333706504740579,-0.0321473979056357,-0.0307935479398931,-0.0293205521351027,-0.0277407910141745,-0.0260674462224488,-0.0243143650464799,-0.022495918850388,-0.0206268570498301,-0.018722158287149,-0.0167968804943409,-0.0148660115329335,-0.0129443220817755,-0.0110462224054127,-0.00918562457778983,-0.00737581165928944,-0.00562931523069587,-0.00395780257685509,-0.00237197468709211,-0.000881476100543156,0.000505182525694962,0.00178068840731456,0.00293897663106015,0.00397526578112388,0.00488607898919126,0.00566925037921095,0.00632391705195106,0.00685049692464134,0.00725065290537006,0.00752724403838587,0.00768426440315268,0.00772677068516773,0.00766079945859612,0.00749327532830533,0.00723191117070981,0.0068851017879842,0.00646181234793383,0.00597146302161105,0.00542381125237269,0.0048288330934597,0.00419660503655721,0.00353718772161089,0.0028605128691012,0.00217627471089687,0.00149382711580243,0.000822087512244983,0.000169448604637587,-0.000456301236625852,-0.00104804815716286,-0.00159941295099129,-0.0021048006598868,-0.0025594392979313,-0.00295940750271046,-0.00330165105754718,-0.00358398836992421,-0.0038051051280543,-0.00396453848868868,-0.00406265127310421,-0.00410059676329298,-0.00408027479535711,-0.00400427994080287,-0.00387584264782596,-0.00369876428295795,-0.00347734706796875,-0.00321631994725671,-0.00292076144686691,-0.0025960205977233,-0.00224763699279651,-0.00188126103110563,-0.00150257537119792,-0.00111721857376409,-0.000730711858188885,-0.000348389832106583,0.0000246640224404445,0.000383676406620381,0.000724237197745367,0.00104234586599819,0.00133445090471228,0.00159748196811403,0.00182887451597576,0.00202658687009381,0.0021891096914678,0.00231546798813999,0.00240521586055087,0.00245842428276349,0.00247566230288982,0.0024579721235205,0.00240683859204616,0.00232415369072974,0.00221217666665937,0.00207349048183871,0.00191095529337147,0.00172765969283364,0.00152687044251632,0.0013119814444287,0.00108646266607783,0.000853809725526682,0.000617494807638463,0.000380919544415395,0.000147370445711614,-0.0000800225867963989,-0.000298324188725302,-0.000504827495597012,-0.000697083797228425,-0.000872927612794052,-0.00103049698774361,-0.00116824888664946,-0.00128496962851463,-0.00137978038207763,-0.00145213780724673,-0.00150182999408168,-0.00152896791188667,-0.00153397263724029,-0.00151755868051019,-0.00148071377502632,-0.00142467553116284,-0.00135090538875969,-0.00126106032536242,-0.00115696279454587,-0.00104056937809392,-0.000913938638121845,-0.000779198650535429,-0.000638514689806091,-0.000494057517277434,-0.000347972701557222,-0.000202351370516586,-0.000059202760601327,0.0000795711088007795,0.000212198349619502,0.000337057465852717,0.000452694764881248,0.000557838770921926,0.000651411540254871,0.00073253682576693,0.000800545085411949,0.00085497537474223,0.000895574207098815,0.000922291505798319,0.000935273810213072,0.000934854931567335,0.000921544284188286,0.000896013143553478,0.00085907910353593,0.000811689021606857,0.000754900752334185,0.000689863976304976,0.000617800433663844,0.000539983868930691,0.000457719986833897,0.000372326707823786,0.000285114997024577,0.000197370521992854,0.000110336373173289,0.0000251970568035976,-0.0000569360563282056,-0.000135037670959719,-0.000208179770298563,-0.000275540985999832,-0.000336414069773947,-0.000390211431494342,-0.000436468738340103,-0.000474846598147686,-0.000505130377368111,-0.000527228229476696,-0.000541167433046304,-0.000547089159698465,-0.000545241810565124,-0.000535973075544534,-0.000519720882389273,-0.000497003412438509,-0.000468408366567089,-0.000434581668682989,-0.000396215794920885,-0.000354037914652738,-0.000308798024707428,-0.000261257250935561,-0.000212176481681707,-0.000162305486069016,-0.000112372656518887,-0.0000630754998979815,-0.0000150719853953071,0.000031027160019411,0.0000746651356170396,0.000115344675744861,0.000152632547154524,0.000186162916628984,0.000215639588363363,0.00024083712746996,0.000261600901934386,0.000277846090140758,0.000289555714532199,0.000296777773927709,0.000299621557357018,0.000298253230910239,0.00029289079596778,0.000283798522247939,0.000271280962382867,0.000255676656235312,0.000237351632950182,0.000216692816877441,0.00019410144010156,0.000169986559493412,0.000144758770094567,0.0001188241994075,0.0000925788589573283,0.0000664034204855043,0.0000406584745065491,0.000015680318885963,-0.00000822268524369438,-0.0000307731633448303,-0.0000517271665913043,-0.0000708759938427668,-0.0000880473998242731,-0.000103106202088968,-0.000115954307930142,-0.000126530190259043,-0.000134807848476977,-0.000140795296486086,-0.000144532625133374,-0.000146089690549095,-0.000145563482985853,-0.000143075232907377,-0.000138767312211351,-0.000132799988647913,-0.000125348090743526,-0.000116597638926578,-0.000106742496141414,-0.0000959810881062454,-0.0000845132396140161,-0.0000725371689682364,-0.000060246677911258,-0.0000478285693020206,-0.0000354603194814351,-0.0000233080267694722,-0.00001152465202471,-0.000000248561695288832,0.000010397621551462,0.000020307860694949,0.0000293932436494599,0.0000375822294275305,0.0000448206147419259,0.0000510712382766032,0.0000563134430434693,0.0000605423199038037,0.000063767757493213,0.0000660133253803229,0.0000673150183943195,0.0000677198905913184,0.0000672846074199914,0.0000660739442081081,0.0000641592582682906,0.0000616169606475209,0.0000585270119571132,0.0000549714647899915,0.0000510330730647211,0.0000467939862492503,0.0000423345438783766,0.0000377321831421186,0.0000330604696224231,0.0000283882585667057,0.0000237789914287717,0.0000192901298433828,0.0000149727267584178,0.0000108711321657484,0.00000702282877715988,0.00000345839111595156,0.000000201559838643236,-0.00000273057827904459,-0.00000532731542799326,-0.00000758396449957796,-0.00000950142971784119,-0.0000110857187222037,-0.0000123474088493083,-0.0000133010801612658,-0.0000139647275313015,-0.0000143591634872533,-0.0000145074229321298,-0.0000144341799410243,-0.0000141651858865594,-0.000013726737038234,-0.000013145178644377,-0.0000124464514674725,-0.0000116556854204182,-0.0000107968436559298,-0.00000989241929479006,-0.00000896318594807151,-0.00000802800230811973,-0.00000710366970929241,-0.00000620484044729922,-0.00000534397442183073,-0.00000453134103870168,-0.00000377506230188068,-0.00000308119204939162,-0.00000637524475755047};

// Holds leftover samples for next batch
jaudio_t overbuff_lp[TAPS_LP-1]; 
jaudio_t overbuff_hp[TAPS_HP-1]; 

// Holds counter for next batch
uint64_t counter_lp = 0;
uint64_t counter_hp = 0;
//unsigned long counter_lp = 0; 
//unsigned long counter_hp = 0; 
	

void init_filters(){
	for(int i=0; i<TAPS_LP-1; i++)
		overbuff_lp[i] = 0;
	for(int i=0; i<TAPS_HP-1; i++)
		overbuff_hp[i] = 0;
}

int filter_lp(jaudio_t* input, jaudio_t* output, jack_nframes_t num_frames)
{
	// Perform safety check to ensure num_frames is big enough
	if(TAPS_LP > num_frames){
		for(int frame=0; frame<num_frames; frame++){
			output[frame] = 0;
		}
		fprintf (stderr, "ERROR!\tBuffer Size (num_frames=%d) is less than the overflow buffer (overbuff=%d frames\n", num_frames, TAPS_LP-1);
	}

	// Make combined buffer
	jaudio_t * comb = (jaudio_t*)malloc(sizeof(jaudio_t)*((TAPS_LP-1)+num_frames));

	// Copy overbuff into combined buffer
	for(int frame=0; frame<(TAPS_LP-1); frame++){
		comb[frame] = overbuff_lp[frame];
	}
	// Copy input into combined buffer
	for(int frame=0; frame<num_frames; frame++){
		comb[frame+(TAPS_LP-1)] = input[frame];
	}

	// Perform the FIR filter
	for(int outFrame=0; outFrame<num_frames; outFrame++){
		double sum = 0; 
		for(int filt=0; filt<(TAPS_LP-1); filt++){
			sum += comb[outFrame+filt]*FIR_LP[filt];
		}
		output[outFrame] = sum; 
	}

	// Copy leftover frames to overbuff
	for(int frame=0; frame<(TAPS_LP-1); frame++){
		overbuff_lp[frame] = input[num_frames-(TAPS_LP-1)+frame];
	}

	counter_lp += num_frames; 

	// Free the combined buffer
	free(comb); 
	return 0; 
} 

int filter_hp(jaudio_t* input, jaudio_t* output, jack_nframes_t num_frames)
{
	// Perform safety check to ensure num_frames is big enough
	if(TAPS_HP > num_frames){
		for(int frame=0; frame<num_frames; frame++){
			output[frame] = 0;
		}
		fprintf (stderr, "ERROR!\tBuffer Size (num_frames=%d) is less than the overflow buffer (overbuff=%d frames\n", num_frames, TAPS_HP-1);
	}

	// Make combined buffer
	jaudio_t * comb = (jaudio_t*)malloc(sizeof(jaudio_t)*((TAPS_HP-1)+num_frames));

	// Copy overbuff into combined buffer
	for(int frame=0; frame<(TAPS_HP-1); frame++){
		comb[frame] = overbuff_hp[frame];
	}
	// Copy input into combined buffer
	for(int frame=0; frame<num_frames; frame++){
		comb[frame+(TAPS_HP-1)] = input[frame];
	}

	// Perform the FIR filter
	for(int outFrame=0; outFrame<num_frames; outFrame++){
		double sum = 0; 
		for(int filt=0; filt<(TAPS_HP-1); filt++){
			sum += comb[outFrame+filt]*FIR_HP[filt];
		}
		output[outFrame] = sum; 
	}

	// Copy leftover frames to overbuff
	for(int frame=0; frame<(TAPS_HP-1); frame++){
		overbuff_hp[frame] = input[num_frames-(TAPS_HP-1)+frame];
	}

	fprintf (stderr, "HP Count %lu \n", counter_hp);
	counter_hp += num_frames; 

	// Free the combined buffer
	free(comb); 
	return 0; 
} 

