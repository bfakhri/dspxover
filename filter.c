#include "filter.h"

#define PI 3.14159265
#define TAPS 401

static double FIRF[TAPS] = {0.000007, 0.000003, -0.000002, -0.000008, -0.000015, -0.000023, -0.000030, -0.000038, -0.000047, -0.000054, -0.000062, -0.000069, -0.000075, -0.000079, -0.000082, -0.000084, -0.000083, -0.000080, -0.000075, -0.000067, -0.000057, -0.000044, -0.000029, -0.000011, 0.000008, 0.000029, 0.000051, 0.000075, 0.000098, 0.000122, 0.000145, 0.000166, 0.000185, 0.000202, 0.000215, 0.000225, 0.000230, 0.000230, 0.000225, 0.000214, 0.000197, 0.000175, 0.000146, 0.000113, 0.000074, 0.000030, -0.000017, -0.000067, -0.000120, -0.000174, -0.000227, -0.000279, -0.000329, -0.000374, -0.000415, -0.000448, -0.000475, -0.000492, -0.000499, -0.000496, -0.000481, -0.000455, -0.000418, -0.000368, -0.000308, -0.000236, -0.000156, -0.000067, 0.000029, 0.000131, 0.000235, 0.000340, 0.000444, 0.000545, 0.000639, 0.000725, 0.000800, 0.000862, 0.000909, 0.000938, 0.000949, 0.000939, 0.000909, 0.000857, 0.000784, 0.000690, 0.000576, 0.000443, 0.000294, 0.000130, -0.000045, -0.000228, -0.000416, -0.000605, -0.000790, -0.000968, -0.001134, -0.001285, -0.001415, -0.001522, -0.001601, -0.001650, -0.001666, -0.001647, -0.001592, -0.001500, -0.001371, -0.001206, -0.001008, -0.000778, -0.000520, -0.000239, 0.000061, 0.000375, 0.000696, 0.001017, 0.001332, 0.001634, 0.001916, 0.002171, 0.002392, 0.002572, 0.002706, 0.002789, 0.002816, 0.002785, 0.002693, 0.002539, 0.002324, 0.002049, 0.001717, 0.001332, 0.000900, 0.000427, -0.000077, -0.000605, -0.001146, -0.001690, -0.002225, -0.002739, -0.003221, -0.003659, -0.004041, -0.004357, -0.004597, -0.004751, -0.004812, -0.004775, -0.004633, -0.004386, -0.004032, -0.003573, -0.003012, -0.002356, -0.001613, -0.000793, 0.000091, 0.001025, 0.001993, 0.002977, 0.003957, 0.004915, 0.005828, 0.006676, 0.007436, 0.008089, 0.008614, 0.008991, 0.009203, 0.009233, 0.009067, 0.008694, 0.008104, 0.007292, 0.006254, 0.004991, 0.003505, 0.001805, -0.000100, -0.002196, -0.004467, -0.006892, -0.009449, -0.012113, -0.014856, -0.017651, -0.020465, -0.023269, -0.026029, -0.028713, -0.031291, -0.033730, -0.036002, -0.038079, -0.039934, -0.041545, -0.042892, -0.043958, -0.044729, -0.045195, 0.954649, -0.045195, -0.044729, -0.043958, -0.042892, -0.041545, -0.039934, -0.038079, -0.036002, -0.033730, -0.031291, -0.028713, -0.026029, -0.023269, -0.020465, -0.017651, -0.014856, -0.012113, -0.009449, -0.006892, -0.004467, -0.002196, -0.000100, 0.001805, 0.003505, 0.004991, 0.006254, 0.007292, 0.008104, 0.008694, 0.009067, 0.009233, 0.009203, 0.008991, 0.008614, 0.008089, 0.007436, 0.006676, 0.005828, 0.004915, 0.003957, 0.002977, 0.001993, 0.001025, 0.000091, -0.000793, -0.001613, -0.002356, -0.003012, -0.003573, -0.004032, -0.004386, -0.004633, -0.004775, -0.004812, -0.004751, -0.004597, -0.004357, -0.004041, -0.003659, -0.003221, -0.002739, -0.002225, -0.001690, -0.001146, -0.000605, -0.000077, 0.000427, 0.000900, 0.001332, 0.001717, 0.002049, 0.002324, 0.002539, 0.002693, 0.002785, 0.002816, 0.002789, 0.002706, 0.002572, 0.002392, 0.002171, 0.001916, 0.001634, 0.001332, 0.001017, 0.000696, 0.000375, 0.000061, -0.000239, -0.000520, -0.000778, -0.001008, -0.001206, -0.001371, -0.001500, -0.001592, -0.001647, -0.001666, -0.001650, -0.001601, -0.001522, -0.001415, -0.001285, -0.001134, -0.000968, -0.000790, -0.000605, -0.000416, -0.000228, -0.000045, 0.000130, 0.000294, 0.000443, 0.000576, 0.000690, 0.000784, 0.000857, 0.000909, 0.000939, 0.000949, 0.000938, 0.000909, 0.000862, 0.000800, 0.000725, 0.000639, 0.000545, 0.000444, 0.000340, 0.000235, 0.000131, 0.000029, -0.000067, -0.000156, -0.000236, -0.000308, -0.000368, -0.000418, -0.000455, -0.000481, -0.000496, -0.000499, -0.000492, -0.000475, -0.000448, -0.000415, -0.000374, -0.000329, -0.000279, -0.000227, -0.000174, -0.000120, -0.000067, -0.000017, 0.000030, 0.000074, 0.000113, 0.000146, 0.000175, 0.000197, 0.000214, 0.000225, 0.000230, 0.000230, 0.000225, 0.000215, 0.000202, 0.000185, 0.000166, 0.000145, 0.000122, 0.000098, 0.000075, 0.000051, 0.000029, 0.000008, -0.000011, -0.000029, -0.000044, -0.000057, -0.000067, -0.000075, -0.000080, -0.000083, -0.000084, -0.000082, -0.000079, -0.000075, -0.000069, -0.000062, -0.000054, -0.000047, -0.000038, -0.000030, -0.000023, -0.000015, -0.000008, -0.000002, 0.000003, 0.000007};


// Holds leftover samples for next batch
jaudio_t overbuff[TAPS-1]; 

// Holds counter for next batch
unsigned long counter = 0; 
	

void init_filter(){
	for(int i=0; i<TAPS-1; i++)
		overbuff[i] = 0;
}

int filter(jaudio_t* input, jaudio_t* output, jack_nframes_t num_frames)
{
	// Make combined buffer
	jaudio_t * comb = (jaudio_t*)malloc(sizeof(jaudio_t)*((TAPS-1)+num_frames));

	// Copy overbuff into combined buffer
	for(int frame=0; frame<(TAPS-1); frame++){
		comb[frame] = overbuff[frame];
	}
	// Copy input into combined buffer
	for(int frame=0; frame<num_frames; frame++){
		comb[frame+(TAPS-1)] = input[frame];
	}

	// Perform the FIR filter
	for(int outFrame=0; outFrame<num_frames; outFrame++){
		double sum = 0; 
		for(int filt=0; filt<(TAPS-1); filt++){
			sum += comb[outFrame+filt]*FIRF[filt];
		}
		output[outFrame] = sum; 
	}

	// Copy leftover frames to overbuff
	for(int frame=0; frame<(TAPS-1); frame++){
		overbuff[frame] = input[num_frames-(TAPS-1)+frame];
	}

	//for(int frame=0; frame<num_frames; frame++)
	//	output[frame] = cos((counter+frame)/PI);	

	counter += num_frames; 

	// Free the combined buffer
	free(comb); 
	return 0; 
} 

/*
int
process (jack_nframes_t nframes, void *arg)
{
	jack_default_audio_sample_t *in, *out;
	
	in = jack_port_get_buffer (input_port, nframes);

	jack_default_audio_sample_t * combined = (jack_default_audio_sample_t*)malloc(sizeof(jack_default_audio_sample_t)*nframes + sizeof(jack_default_audio_sample_t)*(FILTER_TAP_NUM-1)); 

	// Copy Left Buffer into the Combined Buffer
	memcpy(combined, left_buffer, sizeof(jack_default_audio_sample_t)*(FILTER_TAP_NUM-1));
	// Copy Input Buffer into the Combined Buffer
	memcpy(combined+(FILTER_TAP_NUM-1), in, sizeof(jack_default_audio_sample_t)*(nframes - (FILTER_TAP_NUM-1)));
	

	for(int f=0; f<nframes; f++){
		in[f] = 0; 
		for(int t=0; t<FILTER_TAP_NUM; t++){
			in[f] += filter_taps[t]*combined[f+t];
		}
	}

	out = jack_port_get_buffer (output_port, nframes);
	memcpy (out, in,
		sizeof (jack_default_audio_sample_t) * nframes);

	memcpy(left_buffer, combined+nframes, sizeof (jack_default_audio_sample_t)*(FILTER_TAP_NUM-1));

	fprintf (stderr, "Scooted %d frames\n", nframes);

	return 0;      
}*/
